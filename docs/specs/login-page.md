# ç™»å½•é¡µé¢åŠŸèƒ½è§„èŒƒ

## Spec æ¦‚è¿°
æœ¬è§„èŒƒæè¿° FluentWJ ç™»å½•é¡µé¢çš„å‰ç«¯ç»„ä»¶å®ç°å’ŒåŠŸèƒ½é€»è¾‘ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-13
**ç›¸å…³ PRD**: `/docs/prd/[PRD] FluentWJ è·¨å¢ƒå•†åŠ¡å†™ä½œåŠ©æ‰‹é¡¹ç›®éœ€æ±‚æ–‡æ¡£.md`
**ç›¸å…³ç»„ä»¶**:
- `app/(auth)/layout.tsx`
- `app/(auth)/login/page.tsx`
- `components/auth/LoginForm.tsx`
- `utils/validation.ts`

---

## åŠŸèƒ½æè¿°

ç™»å½•é¡µé¢æ˜¯ç”¨æˆ·è¿›å…¥ FluentWJ ç³»ç»Ÿçš„å”¯ä¸€å…¥å£ï¼Œæ”¯æŒä¸¤ç§ç™»å½•æ–¹å¼ï¼š

1. **éªŒè¯ç ç™»å½•**ï¼ˆé»˜è®¤ï¼‰ï¼šé€šè¿‡æ‰‹æœºå· + çŸ­ä¿¡éªŒè¯ç ç™»å½•
2. **å¯†ç ç™»å½•**ï¼šé€šè¿‡æ‰‹æœºå· + å¯†ç ç™»å½•

### æ ¸å¿ƒåŠŸèƒ½
- Tab åˆ‡æ¢ï¼šåœ¨éªŒè¯ç ç™»å½•å’Œå¯†ç ç™»å½•ä¹‹é—´åˆ‡æ¢
- æ‰‹æœºå·è¾“å…¥ï¼šæ”¯æŒä¸­å›½å¤§é™†æ‰‹æœºå·ï¼ˆ+86ï¼‰
- éªŒè¯ç è·å–ï¼š60ç§’å€’è®¡æ—¶åŠŸèƒ½
- å¯†ç å¯è§æ€§åˆ‡æ¢ï¼šç‚¹å‡»å›¾æ ‡æ˜¾ç¤º/éšè—å¯†ç 
- åè®®å‹¾é€‰ï¼šå¿…é¡»åŒæ„æœåŠ¡åè®®å’Œéšç§æ”¿ç­–æ‰èƒ½æäº¤
- æ·±è‰²æ¨¡å¼ï¼šæ”¯æŒæµ…è‰²/æ·±è‰²ä¸»é¢˜åˆ‡æ¢
- å“åº”å¼å¸ƒå±€ï¼šé€‚é…æ¡Œé¢å’Œç§»åŠ¨ç«¯

---

## åŠŸèƒ½é€»è¾‘

### ç™»å½•æµç¨‹ï¼ˆå½“å‰é˜¶æ®µï¼šä»… UIï¼‰

```
ç”¨æˆ·è®¿é—® /login
  â†“
æ˜¾ç¤ºç™»å½•è¡¨å•ï¼ˆé»˜è®¤éªŒè¯ç ç™»å½• Tabï¼‰
  â†“
ç”¨æˆ·è¾“å…¥æ‰‹æœºå·
  â†“
[éªŒè¯ç æ¨¡å¼]                [å¯†ç æ¨¡å¼]
  â†“                           â†“
ç‚¹å‡»"è·å–éªŒè¯ç "            è¾“å…¥å¯†ç 
  â†“                           â†“
è¾“å…¥éªŒè¯ç                   ç‚¹å‡»"å¿˜è®°å¯†ç "ï¼ˆå¯é€‰ï¼‰
  â†“                           â†“
å‹¾é€‰åè®®                    å‹¾é€‰åè®®
  â†“                           â†“
ç‚¹å‡»"ç™»å½•"æŒ‰é’®              ç‚¹å‡»"ç™»å½•"æŒ‰é’®
  â†“                           â†“
å‰ç«¯è¡¨å•éªŒè¯                å‰ç«¯è¡¨å•éªŒè¯
  â†“                           â†“
[TODO: åç»­é˜¶æ®µ]
è°ƒç”¨ API æ¥å£
  â†“
éªŒè¯æˆåŠŸ â†’ è·³è½¬åˆ° /dashboard
éªŒè¯å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯æç¤º
```

---

## æ¥å£å®šä¹‰

### 1. æ•°æ®ç±»å‹å®šä¹‰

```typescript
// ç™»å½•æ¨¡å¼
type LoginMode = 'code' | 'password';

// è¡¨å•æ•°æ®æ¥å£
interface LoginFormData {
  phone: string;          // æ‰‹æœºå·ï¼ˆ11ä½æ•°å­—ï¼‰
  code?: string;          // éªŒè¯ç ï¼ˆéªŒè¯ç ç™»å½•æ—¶ä½¿ç”¨ï¼‰
  password?: string;      // å¯†ç ï¼ˆå¯†ç ç™»å½•æ—¶ä½¿ç”¨ï¼‰
  agreed: boolean;        // æ˜¯å¦åŒæ„åè®®
}

// è¡¨å•é”™è¯¯æ¥å£
interface LoginFormErrors {
  phone?: string;
  code?: string;
  password?: string;
  agreed?: string;
}

// éªŒè¯ç»“æœæ¥å£
interface ValidationResult {
  isValid: boolean;
  error?: string;
}
```

### 2. ç»„ä»¶ Props æ¥å£

```typescript
// LoginForm ç»„ä»¶ Props
interface LoginFormProps {
  onSubmit?: (data: LoginFormData, mode: LoginMode) => void;
  onGetCode?: (phone: string) => Promise<void>;
  isLoading?: boolean;
}
```

### 3. API æ¥å£ï¼ˆåç»­é˜¶æ®µï¼‰

```typescript
// POST /api/auth/send-code
interface SendCodeRequest {
  phone: string;
}

interface SendCodeResponse {
  success: boolean;
  message: string;
  cooldown?: number;  // å‰©ä½™å†·å´æ—¶é—´ï¼ˆç§’ï¼‰
}

// POST /api/auth/login
interface LoginRequest {
  phone: string;
  code?: string;
  password?: string;
}

interface LoginResponse {
  success: boolean;
  message: string;
  user?: {
    id: string;
    phone: string;
    role: number;
  };
  token?: string;
}
```

---

## UI äº¤äº’é€»è¾‘

### 1. Tab åˆ‡æ¢

**åˆå§‹çŠ¶æ€**ï¼š
- é»˜è®¤æ¿€æ´»"éªŒè¯ç ç™»å½•" Tab
- éªŒè¯ç è¾“å…¥æ¡†å¯è§ï¼Œå¯†ç è¾“å…¥æ¡†éšè—

**åˆ‡æ¢è¡Œä¸º**ï¼š
- ç‚¹å‡» Tab æŒ‰é’®åˆ‡æ¢æ¨¡å¼
- æ¿€æ´»çš„ Tab æ˜¾ç¤ºåº•éƒ¨è“è‰²ä¸‹åˆ’çº¿ï¼ˆ2pxï¼‰
- åˆ‡æ¢æ—¶ä¿ç•™æ‰‹æœºå·è¾“å…¥å€¼
- åˆ‡æ¢æ—¶æ¸…ç©ºéªŒè¯ç /å¯†ç è¾“å…¥å€¼

**å®ç°ç»†èŠ‚**ï¼š
```typescript
const [loginMode, setLoginMode] = useState<LoginMode>('code');

const switchTab = (mode: LoginMode) => {
  setLoginMode(mode);
  // ä¿ç•™æ‰‹æœºå·ï¼Œæ¸…ç©ºéªŒè¯ç å’Œå¯†ç 
  setFormData(prev => ({
    ...prev,
    code: '',
    password: ''
  }));
};
```

---

### 2. æ‰‹æœºå·è¾“å…¥

**è¾“å…¥æ¡†ç‰¹æ€§**ï¼š
- å‰ç¼€æ˜¾ç¤ºï¼š`+86`ï¼ˆå›ºå®šï¼Œä¸å¯ä¿®æ”¹ï¼‰
- å ä½ç¬¦ï¼š`è¯·è¾“å…¥æ‰‹æœºå·`
- å›¾æ ‡ï¼šå³ä¾§æ˜¾ç¤ºæ‰‹æœºå›¾æ ‡ï¼ˆ`smartphone`ï¼‰
- è¾“å…¥é™åˆ¶ï¼šä»…å…è®¸æ•°å­—ï¼Œæœ€å¤š 11 ä½

**å®æ—¶éªŒè¯**ï¼š
- é•¿åº¦ä¸è¶³ 11 ä½ï¼šæ— é”™è¯¯æç¤º
- é•¿åº¦è¾¾åˆ° 11 ä½ï¼šè‡ªåŠ¨éªŒè¯æ ¼å¼
- æ ¼å¼é”™è¯¯ï¼šè¾“å…¥æ¡†ä¸‹æ–¹æ˜¾ç¤ºçº¢è‰²é”™è¯¯æç¤º

**éªŒè¯è§„åˆ™**ï¼š
```typescript
// ä¸­å›½å¤§é™†æ‰‹æœºå·æ­£åˆ™
const PHONE_REGEX = /^1[3-9]\d{9}$/;

function validatePhone(phone: string): ValidationResult {
  if (!phone) {
    return { isValid: false, error: 'è¯·è¾“å…¥æ‰‹æœºå·' };
  }
  if (phone.length !== 11) {
    return { isValid: false, error: 'æ‰‹æœºå·å¿…é¡»ä¸º11ä½' };
  }
  if (!PHONE_REGEX.test(phone)) {
    return { isValid: false, error: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼' };
  }
  return { isValid: true };
}
```

---

### 3. éªŒè¯ç è·å–ï¼ˆéªŒè¯ç ç™»å½•æ¨¡å¼ï¼‰

**æŒ‰é’®ä½ç½®**ï¼š
- åµŒå…¥åœ¨éªŒè¯ç è¾“å…¥æ¡†å³ä¾§
- æœ€å°å®½åº¦ï¼š`100px`
- æ ·å¼ï¼šé€æ˜èƒŒæ™¯ + è“è‰²æ–‡å­—

**æŒ‰é’®çŠ¶æ€**ï¼š

| çŠ¶æ€ | æ˜¾ç¤ºæ–‡æœ¬ | å¯ç‚¹å‡» | æ ·å¼ |
|------|---------|--------|------|
| é»˜è®¤ | "è·å–éªŒè¯ç " | âœ… | è“è‰²æ–‡å­— |
| å€’è®¡æ—¶ä¸­ | "60s åé‡æ–°è·å–" | âŒ | ç°è‰²æ–‡å­— |
| æ‰‹æœºå·æœªå¡«å†™ | "è·å–éªŒè¯ç " | âŒ | ç°è‰²æ–‡å­—ï¼ˆdisabledï¼‰ |
| æ‰‹æœºå·æ ¼å¼é”™è¯¯ | "è·å–éªŒè¯ç " | âŒ | ç°è‰²æ–‡å­—ï¼ˆdisabledï¼‰ |

**å€’è®¡æ—¶é€»è¾‘**ï¼š
```typescript
const [countdown, setCountdown] = useState(0);
const [isGettingCode, setIsGettingCode] = useState(false);

const handleGetCode = async () => {
  // éªŒè¯æ‰‹æœºå·
  const validation = validatePhone(formData.phone);
  if (!validation.isValid) {
    toast.error(validation.error);
    return;
  }

  setIsGettingCode(true);
  
  // TODO: è°ƒç”¨å‘é€éªŒè¯ç  API
  // await sendVerificationCode(formData.phone);
  
  // å¯åŠ¨ 60 ç§’å€’è®¡æ—¶
  setCountdown(60);
  const timer = setInterval(() => {
    setCountdown(prev => {
      if (prev <= 1) {
        clearInterval(timer);
        setIsGettingCode(false);
        return 0;
      }
      return prev - 1;
    });
  }, 1000);

  // æ¨¡æ‹ŸæˆåŠŸæç¤º
  toast.success('éªŒè¯ç å·²å‘é€');
};
```

---

### 4. å¯†ç è¾“å…¥ï¼ˆå¯†ç ç™»å½•æ¨¡å¼ï¼‰

**è¾“å…¥æ¡†ç‰¹æ€§**ï¼š
- å ä½ç¬¦ï¼š`è¯·è¾“å…¥å¯†ç `
- ç±»å‹ï¼š`password`ï¼ˆé»˜è®¤éšè—ï¼‰
- å›¾æ ‡ï¼šå³ä¾§æ˜¾ç¤ºé”å›¾æ ‡ï¼ˆ`lock`ï¼‰

**å¯†ç å¯è§æ€§åˆ‡æ¢**ï¼š
- ç‚¹å‡»å³ä¾§å›¾æ ‡åˆ‡æ¢æ˜¾ç¤º/éšè—
- æ˜¾ç¤ºæ—¶ï¼š`type="text"`ï¼Œå›¾æ ‡å˜ä¸º `visibility_off`
- éšè—æ—¶ï¼š`type="password"`ï¼Œå›¾æ ‡ä¸º `visibility`

**å¿˜è®°å¯†ç é“¾æ¥**ï¼š
- ä½ç½®ï¼šå¯†ç è¾“å…¥æ¡†æ ‡ç­¾å³ä¾§
- æ–‡å­—ï¼š`å¿˜è®°å¯†ç ï¼Ÿ`
- æ ·å¼ï¼šè“è‰²æ–‡å­— + hover ä¸‹åˆ’çº¿
- è¡Œä¸ºï¼šè·³è½¬åˆ° `/forgot-password`ï¼ˆå¾…å®ç°ï¼‰

---

### 5. åè®®å‹¾é€‰

**å¿…é€‰éªŒè¯**ï¼š
- ç™»å½•æŒ‰é’®é»˜è®¤å¯ç‚¹å‡»
- æäº¤æ—¶æ£€æŸ¥åè®®æ˜¯å¦å‹¾é€‰
- æœªå‹¾é€‰æ—¶æ˜¾ç¤ºé”™è¯¯æç¤ºï¼š`è¯·å…ˆé˜…è¯»å¹¶åŒæ„æœåŠ¡åè®®`

**é“¾æ¥è·³è½¬**ï¼š
- "æœåŠ¡åè®®" â†’ `/terms`ï¼ˆå¾…åˆ›å»ºï¼‰
- "éšç§æ”¿ç­–" â†’ `/privacy`ï¼ˆå¾…åˆ›å»ºï¼‰
- æ–°æ ‡ç­¾é¡µæ‰“å¼€

---

### 6. ç™»å½•æŒ‰é’®

**æŒ‰é’®çŠ¶æ€**ï¼š
- é»˜è®¤ï¼šè“è‰²èƒŒæ™¯ + ç™½è‰²æ–‡å­—
- Hoverï¼š`bg-primary/90`
- ç‚¹å‡»ï¼š`scale-[0.98]`ï¼ˆè½»å¾®ç¼©å°åŠ¨ç”»ï¼‰
- Loadingï¼šæ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ˆåç»­å®ç°ï¼‰

**æäº¤éªŒè¯**ï¼š
```typescript
const handleSubmit = (e: FormEvent) => {
  e.preventDefault();
  
  // 1. éªŒè¯æ‰‹æœºå·
  const phoneValidation = validatePhone(formData.phone);
  if (!phoneValidation.isValid) {
    toast.error(phoneValidation.error);
    return;
  }

  // 2. éªŒè¯éªŒè¯ç /å¯†ç 
  if (loginMode === 'code') {
    if (!formData.code) {
      toast.error('è¯·è¾“å…¥éªŒè¯ç ');
      return;
    }
    if (formData.code.length !== 6) {
      toast.error('éªŒè¯ç å¿…é¡»ä¸º6ä½æ•°å­—');
      return;
    }
  } else {
    if (!formData.password) {
      toast.error('è¯·è¾“å…¥å¯†ç ');
      return;
    }
    if (formData.password.length < 6) {
      toast.error('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½');
      return;
    }
  }

  // 3. éªŒè¯åè®®å‹¾é€‰
  if (!formData.agreed) {
    toast.error('è¯·å…ˆé˜…è¯»å¹¶åŒæ„æœåŠ¡åè®®');
    return;
  }

  // TODO: è°ƒç”¨ç™»å½• API
  console.log('ç™»å½•æ•°æ®:', formData);
  toast.success('ç™»å½•æˆåŠŸï¼ˆæ¼”ç¤ºï¼‰');
  router.push('/dashboard');
};
```

---

### 7. æ·±è‰²æ¨¡å¼åˆ‡æ¢

**åˆ‡æ¢æŒ‰é’®**ï¼š
- ä½ç½®ï¼šé¡µé¢å³ä¸Šè§’ï¼ˆç»å¯¹å®šä½ï¼‰
- æ ·å¼ï¼šåœ†å½¢æŒ‰é’® + æœˆäº®å›¾æ ‡
- è¡Œä¸ºï¼šåˆ‡æ¢ `html` æ ‡ç­¾çš„ `class="dark"`

**å®ç°æ–¹å¼**ï¼š
```typescript
<button 
  onClick={() => {
    document.documentElement.classList.toggle('dark');
    // ä¿å­˜åˆ° localStorage
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  }}
  className="fixed top-8 right-8 flex h-10 w-10 items-center justify-center rounded-full bg-white dark:bg-white/10 shadow-sm dark:text-white transition-colors"
>
  <span className="material-symbols-outlined text-[20px]">dark_mode</span>
</button>
```

---

## è®¾è®¡è§„èŒƒ

### 1. é¢œè‰²ç³»ç»Ÿ

**å“ç‰Œè‰²**ï¼š
- Primary: `#0052D9`ï¼ˆè“è‰²ï¼Œç”¨äºæŒ‰é’®ã€é“¾æ¥ã€æ¿€æ´»çŠ¶æ€ï¼‰

**èƒŒæ™¯è‰²**ï¼š
- æµ…è‰²æ¨¡å¼ï¼š`#f5f5f8`ï¼ˆé¡µé¢èƒŒæ™¯ï¼‰
- æ·±è‰²æ¨¡å¼ï¼š`#0f0f23`ï¼ˆé¡µé¢èƒŒæ™¯ï¼‰
- è¡¨å•å®¹å™¨ï¼š`white` / `dark:bg-background-dark/50`

**æ–‡å­—é¢œè‰²**ï¼š
- ä¸»æ–‡å­—ï¼š`#0c0c1d` / `dark:white`
- æ¬¡çº§æ–‡å­—ï¼š`#4545a1` / `dark:white/60`
- å ä½ç¬¦ï¼š`#4545a1/60` / `dark:white/30`

**è¾¹æ¡†é¢œè‰²**ï¼š
- è¾“å…¥æ¡†ï¼š`#cdcdea` / `dark:white/20`
- Tab åˆ†éš”çº¿ï¼š`#cdcdea` / `dark:white/10`

---

### 2. å­—ä½“è§„èŒƒ

**å­—ä½“å®¶æ—**ï¼š
```css
font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
```

**å­—å·**ï¼š
- é¡µé¢æ ‡é¢˜ï¼ˆ"FluentWJ"ï¼‰ï¼š`text-2xl` (24px)
- è¡¨å•æ ‡é¢˜ï¼ˆ"ç™»å½• FluentWJ"ï¼‰ï¼š`text-[28px]` (28px)
- Tab æ ‡ç­¾ï¼š`text-sm` (14px)
- è¾“å…¥æ¡†æ ‡ç­¾ï¼š`text-base font-medium` (16px)
- è¾“å…¥æ¡†å†…å®¹ï¼š`text-base` (16px)
- æŒ‰é’®æ–‡å­—ï¼š`text-base font-bold` (16px)
- åè®®æ–‡å­—ï¼š`text-sm` (14px)
- Footer æ–‡å­—ï¼š`text-xs` (12px)

---

### 3. é—´è·è§„èŒƒ

**è¡¨å•å®¹å™¨**ï¼š
- æœ€å¤§å®½åº¦ï¼š`max-w-[440px]`
- å†…è¾¹è·ï¼š`p-8` (32px)
- åœ†è§’ï¼š`rounded-xl` (12px)
- é˜´å½±ï¼š`shadow-xl`

**è¡¨å•å…ƒç´ é—´è·**ï¼š
- è¡¨å•æ•´ä½“ï¼š`space-y-6` (24px)
- Tab ä¸è¡¨å•ï¼š`mb-8` (32px)
- è¾“å…¥æ¡†é«˜åº¦ï¼š`h-14` (56px)
- æŒ‰é’®é«˜åº¦ï¼š`h-14` (56px)

**è¾“å…¥æ¡†å†…éƒ¨**ï¼š
- æ¨ªå‘å†…è¾¹è·ï¼š`p-[15px]`
- å‰ç¼€ï¼ˆ+86ï¼‰ï¼š`pl-4 pr-2`
- å›¾æ ‡å³è¾¹è·ï¼š`pr-[15px]`

---

### 4. åœ†è§’è§„èŒƒ

**Tailwind é…ç½®**ï¼š
```typescript
borderRadius: {
  "DEFAULT": "0.25rem",  // 4px
  "lg": "0.5rem",        // 8px
  "xl": "0.75rem",       // 12px
  "full": "9999px"       // å®Œå…¨åœ†å½¢
}
```

**åº”ç”¨**ï¼š
- Logo å®¹å™¨ï¼š`rounded-lg`
- è¾“å…¥æ¡†ï¼š`rounded-lg`
- æŒ‰é’®ï¼š`rounded-lg`
- è¡¨å•å®¹å™¨ï¼š`rounded-xl`
- ä¸»é¢˜åˆ‡æ¢æŒ‰é’®ï¼š`rounded-full`

---

### 5. é˜´å½±è§„èŒƒ

**è¡¨å•å®¹å™¨**ï¼š
```css
box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
```

**ç™»å½•æŒ‰é’®**ï¼š
```css
box-shadow: 0 10px 15px -3px rgb(5 82 217 / 0.2);
```

---

### 6. å›¾æ ‡ç³»ç»Ÿ

**ä½¿ç”¨ Material Symbols Outlined**ï¼š
- é‚®ä»¶å›¾æ ‡ï¼š`mail`
- æ‰‹æœºå›¾æ ‡ï¼š`smartphone`
- é”å›¾æ ‡ï¼š`lock`
- å¯è§æ€§ï¼š`visibility` / `visibility_off`
- æ·±è‰²æ¨¡å¼ï¼š`dark_mode`

**åŠ è½½æ–¹å¼**ï¼š
```html
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
```

---

## é¡µé¢ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [æ·±è‰²æ¨¡å¼åˆ‡æ¢æŒ‰é’®]                                       â”‚
â”‚                                                         â”‚
â”‚                    [Logo] FluentWJ                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           ç™»å½• FluentWJ                            â”‚ â”‚
â”‚  â”‚                                                   â”‚ â”‚
â”‚  â”‚  [éªŒè¯ç ç™»å½• Tab] â”‚ [å¯†ç ç™»å½• Tab]                â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚ â”‚
â”‚  â”‚                                                   â”‚ â”‚
â”‚  â”‚  æ‰‹æœºå·                                           â”‚ â”‚
â”‚  â”‚  [+86] [_________________] ğŸ“±                     â”‚ â”‚
â”‚  â”‚                                                   â”‚ â”‚
â”‚  â”‚  éªŒè¯ç  / å¯†ç                 [å¿˜è®°å¯†ç ?]          â”‚ â”‚
â”‚  â”‚  [_________________] [è·å–éªŒè¯ç ] / ğŸ”’            â”‚ â”‚
â”‚  â”‚                                                   â”‚ â”‚
â”‚  â”‚  [  ç™» å½•  ]                                      â”‚ â”‚
â”‚  â”‚                                                   â”‚ â”‚
â”‚  â”‚  â˜‘ æˆ‘å·²é˜…è¯»å¹¶åŒæ„ æœåŠ¡åè®® å’Œ éšç§æ”¿ç­–            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚  Â© 2024 FluentWJ AI Writing Assistant                  â”‚
â”‚  ç²¤ICPå¤‡2023000000å·-1  |  AI ç®—æ³•å¤‡æ¡ˆå·: 440300...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¶‰åŠçš„ DB å˜æ›´

### ç›¸å…³æ•°æ®è¡¨

**users è¡¨** (`prisma/schema.prisma`)ï¼š
```prisma
model users {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  phone           String    @unique @db.VarChar(20)
  password_hash   String
  role            Int?      @default(1) @db.SmallInt
  status          Int?      @default(1) @db.SmallInt
  last_login_ip   String?   @db.VarChar(45)
  last_login_time DateTime? @db.Timestamptz(6)
  created_time    DateTime? @default(now()) @db.Timestamptz(6)
  updated_time    DateTime? @default(now()) @db.Timestamptz(6)
}
```

### åç»­æ•°æ®åº“æ“ä½œï¼ˆAPI é˜¶æ®µï¼‰

1. **éªŒè¯ç ç™»å½•**ï¼š
   - æŸ¥è¯¢ `users` è¡¨ï¼Œæ ¹æ® `phone` æŸ¥æ‰¾ç”¨æˆ·
   - å¦‚æœä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆ`password_hash` ä¸ºç©ºï¼‰
   - æ›´æ–° `last_login_ip` å’Œ `last_login_time`

2. **å¯†ç ç™»å½•**ï¼š
   - æŸ¥è¯¢ `users` è¡¨ï¼Œæ ¹æ® `phone` æŸ¥æ‰¾ç”¨æˆ·
   - éªŒè¯ `password_hash`ï¼ˆä½¿ç”¨ bcryptï¼‰
   - æ›´æ–° `last_login_ip` å’Œ `last_login_time`

3. **å®¡è®¡æ—¥å¿—**ï¼š
   - æ¯æ¬¡ç™»å½•å°è¯•è®°å½•åˆ° `admin_operation_logs` æˆ–åˆ›å»ºæ–°è¡¨ `login_logs`

---

## å¼‚å¸¸å¤„ç†

### 1. å®¢æˆ·ç«¯éªŒè¯é”™è¯¯

| åœºæ™¯ | é”™è¯¯æç¤º | æ˜¾ç¤ºæ–¹å¼ |
|------|---------|---------|
| æ‰‹æœºå·ä¸ºç©º | "è¯·è¾“å…¥æ‰‹æœºå·" | Toast æç¤º |
| æ‰‹æœºå·æ ¼å¼é”™è¯¯ | "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼" | Toast æç¤º |
| éªŒè¯ç ä¸ºç©º | "è¯·è¾“å…¥éªŒè¯ç " | Toast æç¤º |
| éªŒè¯ç é•¿åº¦é”™è¯¯ | "éªŒè¯ç å¿…é¡»ä¸º6ä½æ•°å­—" | Toast æç¤º |
| å¯†ç ä¸ºç©º | "è¯·è¾“å…¥å¯†ç " | Toast æç¤º |
| å¯†ç é•¿åº¦ä¸è¶³ | "å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½" | Toast æç¤º |
| æœªå‹¾é€‰åè®® | "è¯·å…ˆé˜…è¯»å¹¶åŒæ„æœåŠ¡åè®®" | Toast æç¤º |

### 2. æœåŠ¡ç«¯é”™è¯¯ï¼ˆåç»­å®ç°ï¼‰

| åœºæ™¯ | HTTP çŠ¶æ€ç  | é”™è¯¯æç¤º |
|------|------------|---------|
| éªŒè¯ç é”™è¯¯ | 400 | "éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥" |
| éªŒè¯ç è¿‡æœŸ | 400 | "éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–" |
| å¯†ç é”™è¯¯ | 401 | "æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯" |
| ç”¨æˆ·è¢«å°ç¦ | 403 | "æ‚¨çš„è´¦æˆ·å·²è¢«å°ç¦ï¼Œè¯·è”ç³»ç®¡ç†å‘˜" |
| å‘é€é¢‘ç¹ | 429 | "æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•" |
| æœåŠ¡å™¨é”™è¯¯ | 500 | "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•" |

### 3. ç½‘ç»œé”™è¯¯

| åœºæ™¯ | é”™è¯¯æç¤º |
|------|---------|
| è¯·æ±‚è¶…æ—¶ | "ç½‘ç»œè¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ" |
| ç½‘ç»œä¸­æ–­ | "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®" |

---

## åç»­æ‰©å±•

### ç¬¬äºŒé˜¶æ®µï¼šAPI é›†æˆ
1. é›†æˆåä¸ºäº‘ SMS æœåŠ¡å‘é€éªŒè¯ç 
2. å®ç° `/api/auth/send-code` æ¥å£
3. å®ç° `/api/auth/login` æ¥å£ï¼ˆéªŒè¯ç  + å¯†ç ï¼‰
4. é›†æˆ NextAuth.js è¿›è¡Œä¼šè¯ç®¡ç†

### ç¬¬ä¸‰é˜¶æ®µï¼šå®Œå–„åŠŸèƒ½
1. å®ç°"å¿˜è®°å¯†ç "æµç¨‹
2. æ·»åŠ å›¾å½¢éªŒè¯ç é˜²æ­¢æœºå™¨äºº
3. å®ç°ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶
4. æ·»åŠ ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ã€ä¼ä¸šå¾®ä¿¡ï¼‰

### ç¬¬å››é˜¶æ®µï¼šåˆè§„å¢å¼º
1. è®°å½•ç™»å½•å®¡è®¡æ—¥å¿—ï¼ˆIPã€è®¾å¤‡ã€æ—¶é—´ï¼‰
2. å¼‚åœ°ç™»å½•æé†’
3. å®åè®¤è¯æµç¨‹
4. è´¦å·å®‰å…¨ä¸­å¿ƒ

---

## éªŒæ”¶æ ‡å‡†

### UI è¿˜åŸåº¦
- [ ] Logo å’Œæ ‡é¢˜å±…ä¸­æ˜¾ç¤º
- [ ] è¡¨å•å®¹å™¨åœ†è§’ã€é˜´å½±æ•ˆæœæ­£ç¡®
- [ ] Tab ä¸‹åˆ’çº¿åŠ¨ç”»ï¼ˆactive çŠ¶æ€ï¼‰
- [ ] è¾“å…¥æ¡†çš„ focus çŠ¶æ€ï¼ˆè“è‰² ringï¼‰
- [ ] éªŒè¯ç æŒ‰é’®åœ¨è¾“å…¥æ¡†å†…éƒ¨å³ä¾§
- [ ] æ·±è‰²æ¨¡å¼åˆ‡æ¢æŒ‰é’®ä½äºå³ä¸Šè§’
- [ ] Footer ç‰ˆæƒä¿¡æ¯å’Œå¤‡æ¡ˆå·æ­£ç¡®æ˜¾ç¤º
- [ ] Material Icons æ­£ç¡®åŠ è½½

### åŠŸèƒ½å®Œæ•´æ€§
- [ ] Tab åˆ‡æ¢æ­£å¸¸å·¥ä½œ
- [ ] æ‰‹æœºå·æ ¼å¼éªŒè¯æ­£ç¡®
- [ ] éªŒè¯ç å€’è®¡æ—¶åŠŸèƒ½æ­£å¸¸
- [ ] å¯†ç å¯è§æ€§åˆ‡æ¢æ­£å¸¸
- [ ] åè®®å‹¾é€‰éªŒè¯æ­£å¸¸
- [ ] æ·±è‰²æ¨¡å¼åˆ‡æ¢æ­£å¸¸
- [ ] å“åº”å¼å¸ƒå±€æ­£å¸¸

### ä»£ç è´¨é‡
- [ ] ä»£ç ç¬¦åˆé¡¹ç›®å‘½åè§„èŒƒ
- [ ] æ‰€æœ‰æ–‡ä»¶åŒ…å«è§„èŒƒå¤´éƒ¨æ³¨é‡Š
- [ ] æ ¸å¿ƒé€»è¾‘åŒ…å«ä¸­æ–‡æ³¨é‡Š
- [ ] æ—  TypeScript é”™è¯¯
- [ ] æ—  ESLint è­¦å‘Š

### ç”¨æˆ·ä½“éªŒ
- [ ] è¡¨å•éªŒè¯æç¤ºæ¸…æ™°
- [ ] æŒ‰é’®çŠ¶æ€åé¦ˆæ˜æ˜¾
- [ ] é¡µé¢åŠ è½½æµç•…æ— å¡é¡¿
- [ ] åŠ¨ç”»è¿‡æ¸¡è‡ªç„¶
- [ ] ç§»åŠ¨ç«¯è§¦æ‘¸ä½“éªŒè‰¯å¥½

---

---

## åç«¯å®ç°è§„èŒƒ

### 1. ç™»å½• API æ¥å£è§„èŒƒ

**æ–‡ä»¶è·¯å¾„**: `app/api/auth/login/route.ts`

**åŠŸèƒ½**: æä¾›éªŒè¯ç ç™»å½•å’Œå¯†ç ç™»å½•æ¥å£ï¼Œè¿”å›å®‰å…¨çš„ Cookie

#### æ¥å£å®šä¹‰

```typescript
// POST /api/auth/login
interface LoginRequest {
  phone: string;       // æ‰‹æœºå·ï¼ˆ11ä½æ•°å­—ï¼‰
  code?: string;       // éªŒè¯ç ï¼ˆéªŒè¯ç ç™»å½•æ—¶ä½¿ç”¨ï¼‰
  password?: string;   // å¯†ç ï¼ˆå¯†ç ç™»å½•æ—¶ä½¿ç”¨ï¼‰
  mode: 'code' | 'password';  // ç™»å½•æ¨¡å¼
}

interface LoginResponse {
  success: boolean;
  message: string;
  user?: {
    id: string;
    phone: string;
    role: number;
  };
  token?: string;                    // JWT Token
  needsPasswordSetup?: boolean;      // æ˜¯å¦éœ€è¦è®¾ç½®å¯†ç ï¼ˆé¦–æ¬¡éªŒè¯ç ç™»å½•ï¼‰
}
```

#### Cookie å®‰å…¨é…ç½®ï¼ˆå¿…é¡»ï¼‰

ç™»å½•æˆåŠŸåå¿…é¡»è®¾ç½®å®‰å…¨çš„ HttpOnly Cookieï¼š

```typescript
response.cookies.set('auth_token', result.token, {
  httpOnly: true,  // ç¦æ­¢ JavaScript è¯»å– Cookieï¼Œé˜²æ­¢ XSS æ”»å‡»
  secure: process.env.NODE_ENV === 'production',  // ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
  sameSite: 'strict',  // é˜²æ­¢ CSRF æ”»å‡»
  maxAge: 60 * 60 * 24,  // 1 å¤©æœ‰æ•ˆæœŸï¼ˆä¸ JWT è¿‡æœŸæ—¶é—´ä¸€è‡´ï¼‰
  path: '/',  // åœ¨æ•´ä¸ªåŸŸåä¸‹æœ‰æ•ˆ
})
```

**å®‰å…¨ç‰¹æ€§è¯´æ˜**:
- `httpOnly: true` - JavaScript æ— æ³•è¯»å– Cookieï¼Œé˜²æ­¢ XSS æ”»å‡»çªƒå– Token
- `secure: true` - ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ HTTPS ä¼ è¾“ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»
- `sameSite: 'strict'` - é˜²æ­¢ CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»

#### éªŒè¯æµç¨‹

1. **å‚æ•°éªŒè¯**
   - æ£€æŸ¥æ‰‹æœºå·æ ¼å¼ï¼ˆ1å¼€å¤´ï¼Œç¬¬äºŒä½3-9ï¼Œå…±11ä½ï¼‰
   - æ£€æŸ¥éªŒè¯ç æ ¼å¼ï¼ˆ6ä½æ•°å­—ï¼‰æˆ–å¯†ç æ ¼å¼ï¼ˆ6-20ä½ï¼‰
   - æ£€æŸ¥ç™»å½•æ¨¡å¼æ˜¯å¦æœ‰æ•ˆ

2. **ä¸šåŠ¡é€»è¾‘**
   - éªŒè¯ç ç™»å½•ï¼šéªŒè¯ Redis ä¸­çš„éªŒè¯ç ï¼ŒéªŒè¯å¤±è´¥æŠ›å‡º `UnauthorizedError`
   - å¯†ç ç™»å½•ï¼šä½¿ç”¨ bcrypt éªŒè¯å¯†ç å“ˆå¸Œï¼ŒéªŒè¯å¤±è´¥æŠ›å‡º `UnauthorizedError`
   - ç”¨æˆ·ä¸å­˜åœ¨ï¼šæŠ›å‡º `UnauthorizedError`ï¼ˆç»Ÿä¸€é”™è¯¯æç¤ºï¼‰
   - ç”¨æˆ·çŠ¶æ€æ£€æŸ¥ï¼šéªŒè¯ç”¨æˆ·æ˜¯å¦è¢«å°ç¦ï¼Œè¢«å°ç¦æŠ›å‡º `ForbiddenError`

3. **ç™»å½•æˆåŠŸ**
   - ç”Ÿæˆ JWT Tokenï¼ˆåŒ…å« userId, phone, roleï¼‰
   - è®¾ç½® HttpOnly Cookie
   - æ›´æ–°ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼ˆlast_login_ip, last_login_timeï¼‰
   - è¿”å›ç”¨æˆ·ä¿¡æ¯å’Œ Token

#### é”™è¯¯å¤„ç†

æ‰€æœ‰é”™è¯¯å¿…é¡»é€šè¿‡ `withErrorHandler` åŒ…è£…ï¼Œè¿”å›ç»Ÿä¸€çš„ JSON æ ¼å¼ï¼š

```typescript
{
  success: false,
  message: 'é”™è¯¯æè¿°',
  error: {
    code: 'ERROR_CODE',
    details?: 'è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰'
  }
}
```

---

### 2. ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰è§„èŒƒ

**æ–‡ä»¶è·¯å¾„**: `middleware.ts`

**åŠŸèƒ½**: ä¿æŠ¤è·¯ç”±ï¼ŒéªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€

#### è·¯ç”±åˆ†ç±»

```typescript
// å—ä¿æŠ¤çš„è·¯ç”±åˆ—è¡¨ï¼ˆéœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ï¼‰
const PROTECTED_ROUTES = ['/dashboard', '/settings']

// å…¬å¼€çš„è·¯ç”±åˆ—è¡¨ï¼ˆæ— éœ€ç™»å½•å³å¯è®¿é—®ï¼‰
const PUBLIC_ROUTES = ['/login', '/set-password']
```

#### éªŒè¯é€»è¾‘

```typescript
export async function middleware(request: NextRequest) {
  const { pathname } = new URL(request.url)

  // 1. ç»Ÿä¸€è·å– Tokenï¼Œé¿å…é‡å¤ä»£ç 
  const token = request.cookies.get('auth_token')?.value

  // 2. å…¬å¼€è·¯ç”±ç›´æ¥æ”¾è¡Œï¼Œä¸æ£€æŸ¥ Token
  if (PUBLIC_ROUTES.some(route => pathname.startsWith(route))) {
    return NextResponse.next()
  }

  // 3. å—ä¿æŠ¤è·¯ç”±éœ€è¦éªŒè¯ Token
  if (PROTECTED_ROUTES.some(route => pathname.startsWith(route))) {
    if (!token) {
      // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µï¼Œå¹¶ä¿å­˜åŸå§‹è·¯å¾„
      const url = new URL('/login', request.url)
      url.searchParams.set('redirect', pathname)
      return NextResponse.redirect(url)
    }

    // éªŒè¯ Token æœ‰æ•ˆæ€§
    const payload = await verifyToken(token)
    if (!payload) {
      // Token æ— æ•ˆæˆ–è¿‡æœŸï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
      const url = new URL('/login', request.url)
      url.searchParams.set('redirect', pathname)
      return NextResponse.redirect(url)
    }

    // Token æœ‰æ•ˆï¼Œå…è®¸è®¿é—®
    return NextResponse.next()
  }

  // 4. æ ¹è·¯ç”±å¤„ç†ï¼šå·²ç™»å½•ç”¨æˆ·è·³è½¬åˆ° Dashboard
  if (pathname === '/') {
    if (token) {
      const payload = await verifyToken(token)
      if (payload) {
        return NextResponse.redirect(new URL('/dashboard', request.url))
      }
    }
  }

  // 5. å…¶ä»–æƒ…å†µæ”¾è¡Œ
  return NextResponse.next()
}
```

**æ³¨æ„äº‹é¡¹**:
- Token åªè·å–ä¸€æ¬¡ï¼Œé¿å…é‡å¤ä»£ç 
- å—ä¿æŠ¤è·¯ç”±å¿…é¡»éªŒè¯ Token æœ‰æ•ˆæ€§
- å…¬å¼€è·¯ç”±ï¼ˆå¦‚ `/set-password`ï¼‰ä¸æ£€æŸ¥ Token
- é‡å®šå‘æ—¶ä¿ç•™åŸå§‹è·¯å¾„ï¼ˆredirect å‚æ•°ï¼‰

---

### 3. è®¾ç½®å¯†ç æ¥å£è§„èŒƒ

**æ–‡ä»¶è·¯å¾„**: `app/api/auth/set-password/route.ts`

**åŠŸèƒ½**: é¦–æ¬¡ç™»å½•åè®¾ç½®å¯†ç ï¼Œè®¾ç½®æˆåŠŸåç›´æ¥è¿›å…¥ dashboard

#### æ¥å£å®šä¹‰

```typescript
// POST /api/auth/set-password
// éœ€è¦è®¤è¯ï¼šBearer Tokenï¼ˆæ¥è‡ªç™»å½•æ¥å£è¿”å›çš„ Tokenï¼‰
interface SetPasswordRequest {
  password: string;        // æ–°å¯†ç ï¼ˆ6-20ä½ï¼‰
  confirmPassword: string;  // ç¡®è®¤å¯†ç 
}

interface SetPasswordResponse {
  success: boolean;
  message: string;
}
```

#### ä¸šåŠ¡é€»è¾‘

1. **Token éªŒè¯**
   - ä» `Authorization` å¤´è·å– Tokenï¼ˆæ ¼å¼ï¼š`Bearer xxx`ï¼‰
   - éªŒè¯ Token æœ‰æ•ˆæ€§
   - Token æ— æ•ˆæˆ–è¿‡æœŸè¿”å› 401

2. **å‚æ•°éªŒè¯**
   - æ£€æŸ¥å¯†ç å’Œç¡®è®¤å¯†ç æ˜¯å¦ä¸ºç©º
   - æ£€æŸ¥å¯†ç é•¿åº¦ï¼ˆ6-20ä½ï¼‰
   - æ£€æŸ¥ä¸¤æ¬¡å¯†ç æ˜¯å¦ä¸€è‡´

3. **å¯†ç è®¾ç½®**
   - è°ƒç”¨ `setPasswordAfterLogin` Service
   - ä½¿ç”¨ bcrypt åŠ å¯†å¯†ç ï¼ˆsalt=10ï¼‰
   - æ›´æ–°æ•°æ®åº“ä¸­çš„ `password_hash` å­—æ®µ

4. **ç™»å½•ä¿æŒ**
   - è®¾ç½®å¯†ç åï¼Œç”¨æˆ· Token ä»ç„¶æœ‰æ•ˆ
   - å‰ç«¯æ¸…é™¤ localStorage ä¸­çš„æ—§ Tokenï¼ˆç°åœ¨ä½¿ç”¨ Cookieï¼‰
   - ç›´æ¥è·³è½¬åˆ° `/dashboard`ï¼Œä¸éœ€è¦é‡æ–°ç™»å½•

#### å‰ç«¯å¤„ç†

```typescript
// app/(auth)/set-password/page.tsx
if (result.success) {
  // è®¾ç½®å¯†ç æˆåŠŸåï¼Œæ¸…é™¤ localStorage
  localStorage.removeItem("auth_token");
  // ç›´æ¥è·³è½¬åˆ° dashboardï¼Œä¸éœ€è¦é‡æ–°ç™»å½•
  router.push("/dashboard");
} else {
  alert(result.message || "è®¾ç½®å¯†ç å¤±è´¥");
}
```

**é‡è¦**: è®¾ç½®å¯†ç å**ä¸éœ€è¦**é‡æ–°ç™»å½•ï¼Œå› ä¸ºç”¨æˆ·å·²ç»å¤„äºç™»å½•çŠ¶æ€ã€‚

---

### 4. ç™»å½•æµç¨‹å®Œæ•´å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€‰æ‹©ç™»å½•æ¨¡å¼ï¼šéªŒè¯ç ç™»å½• / å¯†ç ç™»å½•                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                           â†“
    éªŒè¯ç ç™»å½•æµç¨‹                 å¯†ç ç™»å½•æµç¨‹
              â†“                           â†“
    1. è¾“å…¥æ‰‹æœºå·                1. è¾“å…¥æ‰‹æœºå·
    2. ç‚¹å‡»"è·å–éªŒè¯ç "            2. è¾“å…¥å¯†ç 
    3. è¾“å…¥éªŒè¯ç                 3. ç‚¹å‡»"ç™»å½•"
    4. ç‚¹å‡»"ç™»å½•"
              â†“                           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“
    è°ƒç”¨ POST /api/auth/login
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  åç«¯éªŒè¯é€»è¾‘              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                           â†“
éªŒè¯ç ç™»å½•                  å¯†ç ç™»å½•
    â†“                           â†“
- éªŒè¯ Redis éªŒè¯ç           - éªŒè¯å¯†ç å“ˆå¸Œ
- æŸ¥è¯¢/åˆ›å»ºç”¨æˆ·              - æŸ¥è¯¢ç”¨æˆ·
- æ£€æŸ¥ç”¨æˆ·çŠ¶æ€              - æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
- ç”Ÿæˆ JWT Token             - ç”Ÿæˆ JWT Token
- è®¾ç½® HttpOnly Cookie       - è®¾ç½® HttpOnly Cookie
- æ›´æ–°ç™»å½•ä¿¡æ¯              - æ›´æ–°ç™»å½•ä¿¡æ¯
              â†“                           â†“
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  è¿”å›ç™»å½•æˆåŠŸå“åº”          â”‚
              â”‚  { success, user, token }  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  åˆ¤æ–­æ˜¯å¦éœ€è¦è®¾ç½®å¯†ç        â”‚
              â”‚  needsPasswordSetup?       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“           â†“
                 YES           NO
                    â†“           â†“
        è·³è½¬åˆ° /set-password  è·³è½¬åˆ° /dashboard
                    â†“
        è¾“å…¥æ–°å¯†ç å’Œç¡®è®¤å¯†ç 
                    â†“
        è°ƒç”¨ POST /api/auth/set-password
                    â†“
        éªŒè¯ Tokenï¼ˆå·²ç™»å½•ï¼‰
                    â†“
        è®¾ç½®å¯†ç ï¼ˆbcrypt åŠ å¯†ï¼‰
                    â†“
        å¯†ç è®¾ç½®æˆåŠŸ
                    â†“
        æ¸…é™¤ localStorageï¼ˆæ—§ Tokenï¼‰
                    â†“
        è·³è½¬åˆ° /dashboard âœ“
```

---

### 5. å®‰å…¨è§„èŒƒæ€»ç»“

#### Cookie å®‰å…¨ï¼ˆå¿…é¡»éµå®ˆï¼‰

| é…ç½®é¡¹ | å€¼ | ä½œç”¨ |
|--------|-----|------|
| httpOnly | true | é˜²æ­¢ XSS æ”»å‡»çªƒå– Token |
| secure | true (ç”Ÿäº§) | å¼ºåˆ¶ HTTPS ä¼ è¾“ |
| sameSite | strict | é˜²æ­¢ CSRF è·¨ç«™è¯·æ±‚ä¼ªé€  |
| maxAge | 86400 (1å¤©) | Token æœ‰æ•ˆæœŸ |
| path | / | å…¨ç«™æœ‰æ•ˆ |

#### JWT Token å®‰å…¨

- ä½¿ç”¨ `HS256` ç®—æ³•ç­¾å
- Payload åŒ…å«ï¼šuserId, phone, role
- Secret è‡³å°‘ 32 å­—ç¬¦
- è¿‡æœŸæ—¶é—´ï¼š1 å¤©

#### å¯†ç å®‰å…¨

- ä½¿ç”¨ bcrypt åŠ å¯†ï¼ˆsalt=10ï¼‰
- å¯†ç é•¿åº¦ï¼š6-20 ä½
- ä¸åœ¨æ—¥å¿—ä¸­è®°å½•æ˜æ–‡å¯†ç 
- å¯†ç é”™è¯¯è¿”å›ç»Ÿä¸€æç¤ºï¼š"æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"

#### éªŒè¯ç å®‰å…¨

- 6 ä½æ•°å­—éšæœºéªŒè¯ç 
- æœ‰æ•ˆæœŸï¼š5 åˆ†é’Ÿï¼ˆRedis TTL=300ï¼‰
- å†·å´æ—¶é—´ï¼š60 ç§’
- æ¯æ—¥é™åˆ¶ï¼š10 æ¬¡
- ä½¿ç”¨åç«‹å³åˆ é™¤ï¼ˆä¸€æ¬¡æ€§ï¼‰

---

### 6. é”™è¯¯ç è§„èŒƒ

| é”™è¯¯ç  | HTTP çŠ¶æ€ | åœºæ™¯ | æç¤ºä¿¡æ¯ |
|--------|-----------|------|---------|
| VALIDATION_ERROR | 400 | å‚æ•°éªŒè¯å¤±è´¥ | å…·ä½“å­—æ®µé”™è¯¯æç¤º |
| UNAUTHORIZED | 401 | æœªæˆæƒè®¿é—® | "æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯" / "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ" |
| FORBIDDEN | 403 | ç”¨æˆ·è¢«å°ç¦ | "æ‚¨çš„è´¦æˆ·å·²è¢«å°ç¦ï¼Œè¯·è”ç³»ç®¡ç†å‘˜" |
| NOT_FOUND | 404 | èµ„æºä¸å­˜åœ¨ | "ç”¨æˆ·ä¸å­˜åœ¨" |
| RATE_LIMIT | 429 | è¯·æ±‚è¿‡äºé¢‘ç¹ | "æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•" |
| INTERNAL_SERVER_ERROR | 500 | æœåŠ¡å™¨é”™è¯¯ | "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•" |

---

**æœ€åæ›´æ–°**: 2025-01-15
**æ›´æ–°å†…å®¹**: æ·»åŠ å®Œæ•´çš„ç™»å½•åç«¯è§„èŒƒï¼ŒåŒ…æ‹¬ APIã€Middlewareã€è®¾ç½®å¯†ç æµç¨‹
